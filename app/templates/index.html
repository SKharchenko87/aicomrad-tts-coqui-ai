<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coqui TTS - Text to Speech</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Coqui TTS</h1>
            <p class="subtitle">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π</p>
            <a href="/speakers" class="nav-link">üé§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞–º–∏</a>
        </div>

        <div class="card">
            <form id="ttsForm" method="post" action="/synthesize">
                <div class="form-group">
                    <label for="text">–¢–µ–∫—Å—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞</label>
                    <textarea id="text" name="text" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ–∑–≤—É—á–∏—Ç—å..."
                        maxlength="1000" required></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span> / 1000
                    </div>
                </div>

                <div class="form-group">
                    <label for="model_id">–ú–æ–¥–µ–ª—å</label>
                    <select id="model_id" name="model_id">
                        {% for id, model in models.items() %}
                        <option value="{{ id }}" {% if id=='xtts-v2' %}selected{% endif %}>{{ model.label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" id="speakerGroup" style="display: none;">
                    <label for="speaker">–°–ø–∏–∫–µ—Ä</label>
                    <select id="speaker" name="speaker">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="language">–Ø–∑—ã–∫</label>
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fmt">–§–æ—Ä–º–∞—Ç</label>
                        <select id="fmt" name="fmt">
                            <option value="wav">WAV</option>
                            <option value="mp3">MP3</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="synthesizeBtn">
                    <span class="btn-text">–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å</span>
                    <span class="btn-loader" style="display: none;">
                        <span class="spinner"></span> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
                    </span>
                </button>
            </form>
        </div>

        <div id="resultCard" class="card result-card" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <div class="audio-player">
                <audio id="audioPlayer" controls></audio>
            </div>
            <button id="downloadBtn" class="btn-secondary">
                üì• –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
            </button>
        </div>

        <div id="errorCard" class="card error-card" style="display: none;">
            <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        const models = {{ models | tojson }};
    </script>
    <script>
        const form = document.getElementById('ttsForm');
        const textArea = document.getElementById('text');
        const charCount = document.getElementById('charCount');
        const synthesizeBtn = document.getElementById('synthesizeBtn');
        const btnText = synthesizeBtn.querySelector('.btn-text');
        const btnLoader = synthesizeBtn.querySelector('.btn-loader');
        const resultCard = document.getElementById('resultCard');
        const errorCard = document.getElementById('errorCard');
        const audioPlayer = document.getElementById('audioPlayer');
        const downloadBtn = document.getElementById('downloadBtn');

        const modelSelect = document.getElementById('model_id');
        const langSelect = document.getElementById('language');
        const speakerSelect = document.getElementById('speaker');
        const speakerGroup = document.getElementById('speakerGroup');

        let currentAudioBlob = null;
        let currentFilename = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            updateLanguages();
            updateSpeakers();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —è–∑—ã–∫–æ–≤
        function updateLanguages() {
            const modelId = modelSelect.value;
            const model = models[modelId];

            langSelect.innerHTML = '';
            model.languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang.toUpperCase();
                langSelect.appendChild(option);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–ø–∏–∫–µ—Ä–æ–≤
        async function updateSpeakers() {
            const modelId = modelSelect.value;
            speakerSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            speakerGroup.style.display = 'block';

            try {
                let speakers = [];

                // –î–ª—è XTTS v2 –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/speakers —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–ø–∏–∫–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ)
                if (modelId === 'xtts-v2') {
                    const res = await fetch('/api/speakers');
                    const data = await res.json();
                    speakers = data.speakers.map(s => s.speaker_id);
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π endpoint
                    const res = await fetch(`/speakers/${modelId}`);
                    const data = await res.json();
                    speakers = data.speakers || [];
                }

                speakerSelect.innerHTML = '';
                if (speakers.length > 0) {
                    speakers.forEach(spk => {
                        const option = document.createElement('option');
                        option.value = spk;
                        option.textContent = spk;
                        speakerSelect.appendChild(option);
                    });
                    speakerGroup.style.display = 'block';
                } else {
                    speakerGroup.style.display = 'none';
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Default";
                    speakerSelect.appendChild(option);
                }
            } catch (e) {
                console.error('Error fetching speakers:', e);
                speakerSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }

        modelSelect.addEventListener('change', () => {
            updateLanguages();
            updateSpeakers();
        });

        // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
        textArea.addEventListener('input', () => {
            const count = textArea.value.length;
            charCount.textContent = count;
            if (count > 1000) {
                charCount.style.color = '#ff4444';
            } else {
                charCount.style.color = '#888';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            resultCard.style.display = 'none';
            errorCard.style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            btnText.style.display = 'none';
            btnLoader.style.display = 'flex';
            synthesizeBtn.disabled = true;

            try {
                const formData = new FormData(form);
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞');
                }

                // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ
                currentAudioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(currentAudioBlob);

                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                const contentDisposition = response.headers.get('content-disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        currentFilename = filenameMatch[1];
                    }
                }

                if (!currentFilename) {
                    const fmt = formData.get('fmt') || 'wav';
                    currentFilename = `tts_output.${fmt}`;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
                audioPlayer.src = audioUrl;
                resultCard.style.display = 'block';

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
                audioPlayer.play().catch(err => {
                    console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', err);
                });

            } catch (error) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                document.getElementById('errorMessage').textContent = error.message;
                errorCard.style.display = 'block';
            } finally {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
                synthesizeBtn.disabled = false;
            }
        });

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ
        downloadBtn.addEventListener('click', () => {
            if (currentAudioBlob) {
                const url = URL.createObjectURL(currentAudioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>

</html>